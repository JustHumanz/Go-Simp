<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Channels</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

</head>
<body>
    <div class="container p-5">
        <div class="row row-cols-1 row-cols-md-4">
            {% for v in channels_info['guild_channel'] %}
            <div class="col mb-4">
              <div class="card border-success mb-3">
                <h5 class="card-header">#{{ v['name'] }}</h5>
                <div class="card-body">
                  <div class="row row-cols-1">
                    <button type="button" id="v['id']" class="col mb-1 btn btn-primary" data-bs-toggle="modal" data-bs-target="#{{ v['name'] }}">
                      Update channel
                    </button>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}

            {% for v in channels_info['guild_channel'] %}
            <div class="modal fade" id="{{ v['name'] }}" tabindex="-1" aria-labelledby="{{ v['name'] }}Label" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="{{ v['name'] }}Label">Update channel {{v['name']}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                  <select class="form-select select-agency" aria-label="Select Agency" id="select-agency" channel_id="{{v['id']}}" >
                      <option selected>Select Agency</option>
                      {% for vv in channels_info["agency"] %}
                      <option value="{{ vv['id'] }}"> {{vv['VtuberGroupName']}}</option>
                      {% endfor %}
                  </select>
                  <div id="agency_options">
                    <form action="" id="form-{{v['id']}}" name="form-{{v['id']}}" method="post">
                      <div class="container p-1">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="channel-status-{{v['id']}}">
                          <label class="form-check-label" for="flexSwitchCheckDefault">Channel status </label>
                        </div>
                      </div>
                      <div class="container p-1">
                        <label class="form-label">Channel Option</label>                          
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="dynamic" id="dynamic-{{v['id']}}">
                            <label class="form-check-label" for="flexCheckDefault">
                                dynamic mode
                            </label>
                            <i class="bi bi-info-circle"  data-bs-toggle="popover" title="Dynamic" data-bs-content="Set channel to dynamic notification,Remove past livestream notification from discord channel"></i>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="upcoming" id="upcoming-{{v['id']}}">
                          <label class="form-check-label" for="flexCheckDefault">
                              upcoming
                          </label>
                          <i class="bi bi-info-circle"  data-bs-toggle="popover" title="Upcoming" data-bs-content="Enable new livestreams notification"></i>
                        </div>                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="lite_mode" id="lite_mode-{{v['id']}}">
                            <label class="form-check-label" for="flexCheckDefault">
                                lite mode
                            </label>
                            <i class="bi bi-info-circle"  data-bs-toggle="popover" title="Lite" data-bs-content="Disabling ping user/role function"></i>
                        </div>                      
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="indie_notif" id="indie_notif-{{v['id']}}">
                            <label class="form-check-label" for="flexCheckDefault">
                                indie_notif 
                            </label>
                            <i class="bi bi-info-circle"  data-bs-toggle="popover" title="Indie" data-bs-content="Send all independent vtubers notification"></i>
                        </div>  
                      </div>
    
                      <div class="container p-1">
                        <label class="form-label">Region</label>
                        <div class="form-check">
                          <div class="row" id="select-region-{{v['id']}}">
                            {% for vvv in channels_info["all_region"] %}
                            <div class="col-sm">
                            <div class="form-check checkbox-inline" >
                                  <input class="form-check-input" type="checkbox" name="region" value="{{vvv}}" id="region-{{vvv}}-{{v['id']}}">
                                  <label class="form-check-label" for="flexCheckDefault">{{vvv}}</label>
                            </div>
                            </div>
                            {% endfor %}
                          </div>
                        </div>
                        <div class="container p-1 pb-2">
                          <select class="form-select channel-type" aria-label="select channel type" id="channel-type-{{v['id']}}" name="channel">
                              <option value="-1" id="null">Select channel type</option>
                              <option value="1" id="fanart-{{v['id']}}">Fanart</option>
                              <option value="2" id="livestream-{{v['id']}}">Livestream</option>
                              <option value="69" id="lewd-{{v['id']}}">Lewd</option>
                              <option value="3" id="fanart-livestream-{{v['id']}}">Fanart & Livestream</option>
                              <option value="70" id="fanart-lewd-{{v['id']}}">Fanart & Lewd</option>
                          </select>
                        </div>

                        <button type="submit" name="submit-{{v['id']}}" id="submit-{{v['id']}}" value="Submit" class="btn btn-primary">Submit</button>
                    </form>
                  </div>
                   </div>
                  </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
        </div>
      </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script>
var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
  return new bootstrap.Popover(popoverTriggerEl)
})
</script>

<script>
  $('body').on('change', '#select-agency', function() {
    agency_id = $(this).val()
    channel_id = $(this).attr('channel_id')

    $(function() {
      $("#select-region-"+channel_id+" .form-check-input").each(function() {
        $(this).prop('checked', false);
        $(this).prop('disabled', true);
      });
    });   

    console.log(agency_id,channel_id)
    fetch( location.protocol + '//' + location.host+"/channel/"+channel_id+"/"+agency_id)
      .then(response => response.json())
      .then(data => {
        console.log(data)
        let disabled = function(){
            $("#dynamic-"+channel_id).prop('disabled', true);
            $("#lite_mode-"+channel_id).prop('disabled', true);
            $("#upcoming-"+channel_id).prop('disabled', true);
            if (agency_id != 10) {
              $("#indie_notif-"+channel_id).prop("disabled", true);
            }
            data["channel_data"]["region"].forEach(function (item,index){
              $("#region-"+item+"-"+channel_id).prop('checked', false);
              $("#region-"+item+"-"+channel_id).prop('disabled', true);
            });                       
        }

        let enabled = function(){
            $("#dynamic-"+channel_id).prop('disabled', false);
            $("#lite_mode-"+channel_id).prop('disabled', false);
            $("#upcoming-"+channel_id).prop('disabled', false);
            if (agency_id != 10) {
              $("#indie_notif-"+channel_id).prop("disabled", false);
            } 
            data["channel_data"]["region"].forEach(function (item,index){
              $("#region-"+item+"-"+channel_id).prop('disabled', false);
              $("#region-"+item+"-"+channel_id).prop('checked', true);              
            });            
        }

        if (data["channel_data"]["type"] == null) {
          disabled()
          
          $("#channel-status-"+channel_id).on('change', function() {
            if (this.checked) {
              enabled()
            } else {
              disabled()
            }
          })
          
          $("#channel-status-"+channel_id).prop('checked', false);
          
          $("#dynamic-"+channel_id).prop('checked', false);

          $("#indie_notif-"+channel_id).prop('checked', false);

          $("#lite_mode-"+channel_id).prop('checked', false);

          $("#upcoming-"+channel_id).prop('checked', false);

          
          $("#channel-type-"+channel_id).prop('selectedIndex',0);
        } else{
          $("#channel-status-"+channel_id).on('change', function() {
            if (this.checked) {
              enabled()
            } else {
              disabled()
            }
          })

          $("#channel-status-"+channel_id).prop('checked', true);

          if (data["channel_data"]["dynamic"] == null || data["channel_data"]["dynamic"] == false) {
              $("#dynamic-"+channel_id).prop('checked', false);
            } else if (data["channel_data"]["dynamic"] == true){
              $("#dynamic-"+channel_id).prop('checked', true);
            }

            if (data["channel_data"]["indie_notif"] == null || data["channel_data"]["indie_notif"] == false) {
              $("#indie_notif-"+channel_id).prop('checked', false);
            } else if (data["channel_data"]["indie_notif"] == true){
              $("#indie_notif-"+channel_id).prop('checked', true);
            }
            
            if (data["channel_data"]["lite"] == null || data["channel_data"]["lite"] == false) {
              $("#lite_mode-"+channel_id).prop('checked', false);
            } else if (data["channel_data"]["lite_mode"] == true){
              $("#lite_mode-"+channel_id).prop('checked', true);
            }

            if (data["channel_data"]["upcoming"] == null || data["channel_data"]["upcoming"] == false) {
              $("#upcoming-"+channel_id).prop('checked', false);
            } else if (data["channel_data"]["upcoming"] == true){
              $("#upcoming-"+channel_id).prop('checked', true);
            }
        
          data["channel_data"]["region"].forEach(function (item,index){
            $("#region-"+item+"-"+channel_id).prop('disabled', false);
            $("#region-"+item+"-"+channel_id).prop('checked', true);
          });
        }

        
        if (data["channel_data"]["type"]== 1) {
          $("#fanart-"+channel_id).attr("selected",true);
          $("#channel-type-"+channel_id).prop('selectedIndex',1);

        } else if (data["channel_data"]["type"]== 2) {
          $("#livestream-"+channel_id).attr("selected",true);
          $("#channel-type-"+channel_id).prop('selectedIndex',2);

        } else if (data["channel_data"]["type"]== 69) {
          $("#lewd-"+channel_id).attr("selected",true);
          $("#channel-type-"+channel_id).prop('selectedIndex',3);

        } else if (data["channel_data"]["type"]== 3) {
          $("#fanart-livestream-"+channel_id).attr("selected",true);
          $("#channel-type-"+channel_id).prop('selectedIndex',4);

        } else if (data["channel_data"]["type"]== 70) {
          $("#fanart-lewd-"+channel_id).attr("selected",true);
          $("#channel-type-"+channel_id).prop('selectedIndex',5);

        }

        $("#form-"+channel_id).submit(function (){
          console.log($(this))
        })
      });


    
  });

</script>
</html>